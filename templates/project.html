{% extends "base.html" %}
{% block title %}{{ project['name'] }} - Test Repository{% endblock %}
{% block content %}
<div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px;">
    <h2 style="margin-bottom: 0; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ project['name'] }}</h2>
    <div class="btn-group" style="flex-shrink: 0;">
        <a href="{{ url_for('export_project', project_id=project['id']) }}" class="btn btn-secondary btn-xs">Export MD</a>
        <a href="{{ url_for('export_project', project_id=project['id'], format='csv') }}" class="btn btn-secondary btn-xs">Export CSV</a>
        <form method="POST" action="{{ url_for('import_tests', project_id=project['id']) }}" enctype="multipart/form-data"
              class="btn-group">
            <input type="file" name="file" accept=".csv" required style="font-size: 0.75rem;">
            <button type="submit" class="btn btn-secondary btn-xs">Import CSV</button>
        </form>
    </div>
</div>

<div class="card">
    <h3>Add Test</h3>
    <form method="POST" action="{{ url_for('create_test', project_id=project['id']) }}">
        <label class="field-label" for="description">Test Description</label>
        <input type="text" id="description" name="description" placeholder="What is being tested" required>

        <label class="field-label" for="steps">Test Steps</label>
        <textarea id="steps" name="steps" placeholder="Step-by-step instructions to execute the test" required></textarea>

        <button type="submit" class="btn btn-primary">Add Test</button>
    </form>
</div>

<div class="btn-group" style="margin-bottom: 16px;">
    <a href="{{ url_for('project_detail', project_id=project['id']) }}"
       class="btn btn-sm {{ 'btn-primary' if status_filter == 'all' else 'btn-secondary' }}">All</a>
    <a href="{{ url_for('project_detail', project_id=project['id'], status='pass') }}"
       class="btn btn-sm {{ 'btn-primary' if status_filter == 'pass' else 'btn-secondary' }}">Passed</a>
    <a href="{{ url_for('project_detail', project_id=project['id'], status='fail') }}"
       class="btn btn-sm {{ 'btn-primary' if status_filter == 'fail' else 'btn-secondary' }}">Failed</a>
    <a href="{{ url_for('project_detail', project_id=project['id'], status='pending') }}"
       class="btn btn-sm {{ 'btn-primary' if status_filter == 'pending' else 'btn-secondary' }}">Pending</a>
    <span style="border-left: 1px solid var(--border); margin: 0 4px;"></span>
    <a href="{{ url_for('project_detail', project_id=project['id'], assigned='me') }}"
       class="btn btn-sm {{ 'btn-primary' if assigned_filter == 'me' else 'btn-secondary' }}">Assigned to Me</a>
    <span style="border-left: 1px solid var(--border); margin: 0 4px;"></span>
    <button class="btn btn-sm btn-secondary" onclick="toggleAll(true)">Expand All</button>
    <button class="btn btn-sm btn-secondary" onclick="toggleAll(false)">Collapse All</button>
    <span style="border-left: 1px solid var(--border); margin: 0 4px;"></span>
    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.85rem;">
        <input type="checkbox" class="bulk-check" id="select-all" onchange="toggleSelectAll(this.checked)"> Select All
    </label>
</div>

<div class="bulk-bar" id="bulk-bar" style="display: none;">
    <span class="bulk-count" id="bulk-count">0 test(s) selected</span>
    <form method="POST" action="{{ url_for('bulk_action', project_id=project['id']) }}" id="bulk-form" style="display: contents;">
        <input type="hidden" name="test_ids" id="bulk-test-ids">
        <input type="hidden" name="action" id="bulk-action-field">
        <input type="hidden" name="assign_to" id="bulk-assign-to">
        <button type="button" class="btn btn-sm" style="background: var(--badge-pass-text); color: #fff;" onclick="submitBulk('pass')">Mark Pass</button>
        <button type="button" class="btn btn-sm" style="background: var(--badge-fail-text); color: #fff;" onclick="submitBulk('fail')">Mark Fail</button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="submitBulk('pending')">Mark Pending</button>
        <select id="bulk-assign-select" style="padding: 4px 8px; border: 1px solid var(--input-border); border-radius: 6px; font-size: 0.8rem; background: var(--input-bg); color: var(--input-text);"
                onchange="if(this.value!==''){submitBulkAssign(this.value)}">
            <option value="">Assign to...</option>
            <option value="__unassign__">Unassigned</option>
            {% for u in users %}
                <option value="{{ u['username'] }}">{{ u['username'] }}</option>
            {% endfor %}
        </select>
        <button type="button" class="btn btn-sm btn-danger" onclick="submitBulk('delete')">Delete Selected</button>
    </form>
</div>

{% if tests %}
    {% for test in tests %}
    <div class="card" data-test-id="{{ test['id'] }}">
        <div class="test-header">
            <input type="checkbox" class="bulk-check test-check" value="{{ test['id'] }}" onchange="updateBulkBar()">
            <div class="test-summary" onclick="toggleTest({{ test['id'] }})">
                {% if test['passed'] == 1 %}
                    <span class="badge badge-pass">Pass</span>
                {% elif test['passed'] == 0 %}
                    <span class="badge badge-fail">Fail</span>
                {% else %}
                    <span class="badge badge-pending">Pending</span>
                {% endif %}
                <span class="desc-preview">{{ test['description'] }}</span>
                {% if test['assigned_to'] %}<span class="meta-preview">{{ test['assigned_to'] }}</span>{% endif %}
            </div>
            <div class="btn-group">
                <button type="button" class="toggle-btn" onclick="toggleTest({{ test['id'] }})" id="toggle-{{ test['id'] }}">Show</button>
                <form method="POST" action="{{ url_for('move_test', test_id=test['id'], direction='up') }}" class="inline-form">
                    <button type="submit" class="btn btn-secondary btn-sm" {% if loop.first %}disabled{% endif %}>Move Up</button>
                </form>
                <form method="POST" action="{{ url_for('move_test', test_id=test['id'], direction='down') }}" class="inline-form">
                    <button type="submit" class="btn btn-secondary btn-sm" {% if loop.last %}disabled{% endif %}>Move Down</button>
                </form>
                <form method="POST" action="{{ url_for('delete_test', test_id=test['id']) }}" class="inline-form"
                      onsubmit="return confirm('Delete this test?')">
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
            </div>
        </div>

        <div class="test-body collapsed" id="test-body-{{ test['id'] }}">
        <form method="POST" action="{{ url_for('update_test', test_id=test['id']) }}">

            <div class="meta">
                {% if test['created_by'] %}<span>Created by: <strong>{{ test['created_by'] }}</strong></span>{% endif %}
                {% if test['executed_by'] %}<span>Executed by: <strong>{{ test['executed_by'] }}</strong>{% if test['executed_at'] %} on {{ test['executed_at'] }}{% endif %}</span>{% endif %}
                {% if test['assigned_to'] %}<span>Assigned to: <strong>{{ test['assigned_to'] }}</strong></span>{% endif %}
            </div>

            <label class="field-label">Assigned To</label>
            <select name="assigned_to" style="width: 100%; padding: 8px 12px; border: 1px solid var(--input-border); border-radius: 6px; font-size: 0.95rem; font-family: inherit; margin-bottom: 12px; background: var(--input-bg); color: var(--input-text);">
                <option value="">Unassigned</option>
                {% for u in users %}
                    <option value="{{ u['username'] }}" {{ 'selected' if test['assigned_to'] == u['username'] else '' }}>{{ u['username'] }}</option>
                {% endfor %}
            </select>

            <label class="field-label">Description</label>
            <input type="text" name="description" value="{{ test['description'] }}" required>

            <label class="field-label">Test Steps</label>
            <textarea name="steps">{{ test['steps'] }}</textarea>

            <label class="field-label">Result</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="passed" value="" {{ '' if test['passed'] is not none else 'checked' }}>
                    Pending
                </label>
                <label>
                    <input type="radio" name="passed" value="1" {{ 'checked' if test['passed'] == 1 else '' }}>
                    Pass
                </label>
                <label>
                    <input type="radio" name="passed" value="0" {{ 'checked' if test['passed'] == 0 else '' }}>
                    Fail
                </label>
            </div>

            <label class="field-label">Test Output</label>
            <textarea name="output" placeholder="Paste test output here">{{ test['output'] }}</textarea>

            {% if test['output'] %}
                <div class="output-block">{{ test['output'] }}</div>
            {% endif %}

            <label class="field-label">Notes</label>
            <textarea name="notes" placeholder="Internal notes, observations, or comments">{{ test['notes'] }}</textarea>

            <div style="margin-top: 12px;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>

        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
            <label class="field-label">Attachments</label>
            {% if attachments.get(test['id']) %}
                <ul style="list-style: none; padding: 0; margin-bottom: 12px;">
                    {% for att in attachments[test['id']] %}
                    <li style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <a href="{{ url_for('download_attachment', attachment_id=att['id']) }}">{{ att['original_name'] }}</a>
                        <form method="POST" action="{{ url_for('delete_attachment', attachment_id=att['id']) }}" class="inline-form"
                              onsubmit="return confirm('Delete this attachment?')">
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            {% endif %}
            <form method="POST" action="{{ url_for('upload_attachment', test_id=test['id']) }}" enctype="multipart/form-data"
                  class="btn-group">
                <input type="file" name="file" required style="font-size: 0.85rem;">
                <button type="submit" class="btn btn-secondary btn-sm">Upload</button>
            </form>
        </div>

        {% if history.get(test['id']) %}
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
            <label class="field-label">History</label>
            <ul style="list-style: none; padding: 0; font-size: 0.85rem; color: var(--muted);">
                {% for entry in history[test['id']] %}
                <li style="margin-bottom: 4px;">
                    <strong>{{ entry['changed_by'] }}</strong>
                    changed status from
                    <strong>{{ entry['old_status'] or 'Pending' }}</strong>
                    to
                    <strong>{{ entry['new_status'] or 'Pending' }}</strong>
                    <span style="font-size: 0.8rem;">&mdash; {{ entry['changed_at'] }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
            <label class="field-label">Comments</label>
            {% if comments.get(test['id']) %}
                <ul style="list-style: none; padding: 0; margin-bottom: 12px;">
                    {% for cmt in comments[test['id']] %}
                    <li style="margin-bottom: 8px; font-size: 0.9rem;">
                        <div>
                            <strong>{{ cmt['username'] }}</strong>
                            <span style="color: var(--muted); font-size: 0.8rem;">&mdash; {{ cmt['created_at'] }}</span>
                            {% if cmt['username'] == g.user['username'] or g.user['is_admin'] %}
                            <form method="POST" action="{{ url_for('delete_comment', comment_id=cmt['id']) }}" class="inline-form"
                                  onsubmit="return confirm('Delete this comment?')">
                                <button type="submit" class="btn btn-danger btn-sm" style="margin-left: 4px;">Delete</button>
                            </form>
                            {% endif %}
                        </div>
                        <div style="margin-top: 2px;">{{ cmt['body'] }}</div>
                    </li>
                    {% endfor %}
                </ul>
            {% endif %}
            <form method="POST" action="{{ url_for('add_comment', test_id=test['id']) }}" style="display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap;">
                <textarea name="body" placeholder="Add a comment..." required style="min-height: 40px; flex: 1;"></textarea>
                <button type="submit" class="btn btn-secondary btn-sm" style="margin-top: 0;">Comment</button>
            </form>
        </div>
        </div>{# end test-body #}
    </div>
    {% endfor %}
{% else %}
    {% if status_filter != 'all' or assigned_filter %}
        <p style="color: var(--muted);">No tests match this filter.</p>
    {% else %}
        <p style="color: var(--muted);">No tests yet. Add one above.</p>
    {% endif %}
{% endif %}
<script>
function toggleTest(id) {
    var body = document.getElementById('test-body-' + id);
    var btn = document.getElementById('toggle-' + id);
    if (body.classList.contains('collapsed')) {
        body.classList.remove('collapsed');
        btn.textContent = 'Hide';
        sessionStorage.setItem('test-' + id, 'open');
    } else {
        body.classList.add('collapsed');
        btn.textContent = 'Show';
        sessionStorage.removeItem('test-' + id);
    }
}
function toggleAll(expand) {
    document.querySelectorAll('.test-body').forEach(function(el) {
        var id = el.id.replace('test-body-', '');
        var btn = document.getElementById('toggle-' + id);
        if (expand) {
            el.classList.remove('collapsed');
            if (btn) btn.textContent = 'Hide';
            sessionStorage.setItem('test-' + id, 'open');
        } else {
            el.classList.add('collapsed');
            if (btn) btn.textContent = 'Show';
            sessionStorage.removeItem('test-' + id);
        }
    });
}
function updateBulkBar() {
    var checks = document.querySelectorAll('.test-check:checked');
    var bar = document.getElementById('bulk-bar');
    var countEl = document.getElementById('bulk-count');
    var selectAll = document.getElementById('select-all');
    var allChecks = document.querySelectorAll('.test-check');
    if (checks.length > 0) {
        bar.style.display = 'flex';
        countEl.textContent = checks.length + ' test(s) selected';
    } else {
        bar.style.display = 'none';
    }
    selectAll.checked = allChecks.length > 0 && checks.length === allChecks.length;
}
function toggleSelectAll(checked) {
    document.querySelectorAll('.test-check').forEach(function(cb) { cb.checked = checked; });
    updateBulkBar();
}
function submitBulk(action) {
    var checks = document.querySelectorAll('.test-check:checked');
    if (checks.length === 0) return;
    if (action === 'delete' && !confirm('Delete ' + checks.length + ' selected test(s)?')) return;
    var ids = Array.from(checks).map(function(cb) { return cb.value; }).join(',');
    document.getElementById('bulk-test-ids').value = ids;
    document.getElementById('bulk-action-field').value = action;
    document.getElementById('bulk-form').submit();
}
function submitBulkAssign(val) {
    var checks = document.querySelectorAll('.test-check:checked');
    if (checks.length === 0) { document.getElementById('bulk-assign-select').value = ''; return; }
    var ids = Array.from(checks).map(function(cb) { return cb.value; }).join(',');
    document.getElementById('bulk-test-ids').value = ids;
    document.getElementById('bulk-action-field').value = 'assign';
    document.getElementById('bulk-assign-to').value = val === '__unassign__' ? '' : val;
    document.getElementById('bulk-form').submit();
}
(function() {
    document.querySelectorAll('.test-body').forEach(function(el) {
        var id = el.id.replace('test-body-', '');
        if (sessionStorage.getItem('test-' + id) === 'open') {
            el.classList.remove('collapsed');
            var btn = document.getElementById('toggle-' + id);
            if (btn) btn.textContent = 'Hide';
        }
    });
})();
</script>
{% endblock %}
